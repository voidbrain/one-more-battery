<ion-header>
  <ion-toolbar>
    <ion-title>{{ 'batteries.title' | transloco }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  @if (isLoading()) {
    <ion-item>
      <ion-spinner></ion-spinner>
      <ion-label class="ion-padding-start">{{ 'batteries.loading' | transloco }}</ion-label>
    </ion-item>
  } @else {
    <app-actions-bar
      class="ion-padding-bottom"
      (qrCodeScanned)="onQrCodeScanned($event)"
      (photoTaken)="onPhotoTaken($event)"
    >
    </app-actions-bar>
    <ion-card color="secondary">
      <ion-card-content>
        @for (seriesEntry of groupedBatteries() | keyvalue; track seriesEntry.key) {
          <ion-list class="ion-padding-bottom">
            <ion-list-header>
              <ion-label>{{ seriesEntry.key }}</ion-label>
            </ion-list-header>
            <ion-grid>
              <ion-row>
                @for (battery of seriesEntry.value; track battery.id) {
                  <ion-col size="12" size-md="6" size-lg="4">
                    <ion-card color="warning">
                      <ion-card-header>

                        <ion-card-title color="primary">
                          <div class="ion-float-start">
                          <ion-icon [name]="getStatusIcon(battery.status)"></ion-icon>
                          @if (battery.alertStatus !== 'green') {
                            <ion-icon [name]="getAlertIcon(battery.alertStatus)"></ion-icon>
                          }
                        </div>
                          Battery {{ battery.label }}</ion-card-title>
                        <ion-card-subtitle
                          >{{ battery.statusText }}
                          {{ formatTimeAgo(battery.daysSinceLastAction) }}</ion-card-subtitle
                        >
                      </ion-card-header>
                      <ion-card-content>
                        <ion-item>
                          <ion-label>
                            <p>{{ battery.brand?.label }}</p>
                            <p>{{ battery.model }}</p>
                            <p>
                              {{ battery.type?.label }} {{ battery.cellsNumber }}S {{ battery.mA }}mA
                            </p>
                          </ion-label>
                        </ion-item>
                        <ion-grid>
                          <ion-row>
                            <ion-col>
                              <strong>{{ 'batteries.labels.cycles' | transloco }}:</strong>
                              {{ battery.cycleCount }}
                            </ion-col>
                            <ion-col>
                              <strong>{{ 'batteries.labels.age' | transloco }}:</strong>
                              {{ formatAge(battery.age) }}
                            </ion-col>
                          </ion-row>
                        </ion-grid>
                        <ion-row class="ion-justify-content-end ion-align-items-center">
                          <ion-button
                            (click)="generateQrCode(battery)"
                            [title]="'batteries.generateQr' | transloco"
                          >
                            <ion-icon name="print" slot="icon-only"></ion-icon>
                          </ion-button>

                          <ion-button
                            (click)="viewCycleLogs(battery)"
                            [title]="'batteries.viewCycleLogs' | transloco"
                          >
                            <ion-icon name="analytics" slot="icon-only"></ion-icon>
                          </ion-button>

                          <ion-button
                            (click)="viewResistanceLogs(battery)"
                            [title]="'batteries.viewResistanceLogs' | transloco"
                          >
                            <ion-icon name="pulse" slot="icon-only"></ion-icon>
                          </ion-button>

                          <ion-button
                            (click)="openActionSheet(battery)"
                            [title]="'batteries.batteryActions' | transloco"
                          >
                            <ion-icon name="ellipsis-vertical" slot="icon-only"></ion-icon>
                          </ion-button>
                        </ion-row>
                      </ion-card-content>
                    </ion-card>
                  </ion-col>
                }
              </ion-row>
            </ion-grid>
          </ion-list>
        }

        @if (groupedBatteries().size === 0) {
          <ion-card class="ion-text-center ion-padding">
            <ion-card-content>
              <ion-icon name="battery-charging" size="large"></ion-icon>
              <ion-card-title>{{ 'batteries.emptyState.title' | transloco }}</ion-card-title>
              <ion-text color="medium">
                <p>{{ 'batteries.emptyState.description' | transloco }}</p>
              </ion-text>
            </ion-card-content>
          </ion-card>
        }
      </ion-card-content>
    </ion-card>
  }
</ion-content>
