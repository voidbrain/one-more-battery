<ion-header>
  <ion-toolbar>
    <ion-title>{{ 'resistance.title' | transloco }} - {{ batteryLabel }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>
<ion-content class="ion-padding">
  <!-- Battery Analytics Summary -->
  <ion-card class="glass-card">
    <ion-card-header>
      <ion-card-title>{{ 'resistance.analytics.title' | transloco }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px">
        <div>
          <strong>{{ 'resistance.analytics.totalRecords' | transloco }}:</strong> {{ totalRecords }}
        </div>
        <div>
          <strong>{{ 'resistance.analytics.cells' | transloco }}:</strong> {{ cellData.length }}
        </div>
        @if (firstRecordDate) {
          <div>
            <strong>{{ 'resistance.analytics.firstRecord' | transloco }}:</strong><br />
            {{ firstRecordDate }}
          </div>
        }
        @if (lastRecordDate) {
          <div>
            <strong>{{ 'resistance.analytics.lastRecord' | transloco }}:</strong><br />
            {{ lastRecordDate }}
          </div>
        }
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Resistance Chart -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ 'resistance.chart.title' | transloco }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div style="position: relative; height: 250px; width: 100%">
        <canvas #resistanceChartCanvas></canvas>
      </div>
      <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px">
        {{ 'resistance.chart.description' | transloco }}
      </p>
    </ion-card-content>
  </ion-card>

  <!-- Cell Data Table -->
  @if (cellData.length > 0) {
    <ion-card>
      <ion-card-header>
        <ion-card-title>{{ 'resistance.table.title' | transloco }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row style="font-weight: bold; background: var(--bg-secondary)">
            <ion-col size="4">{{ 'resistance.table.cellName' | transloco }}</ion-col>
            <ion-col size="4">{{ 'resistance.table.firstRead' | transloco }}</ion-col>
            <ion-col size="4">{{ 'resistance.table.lastRead' | transloco }}</ion-col>
          </ion-row>
          @for (cell of cellData; track cell.name) {
            <ion-row>
              <ion-col size="4">{{ cell.name }}</ion-col>
              <ion-col size="4">{{ cell.firstRead }}</ion-col>
              <ion-col size="4">{{ cell.lastRead }}</ion-col>
            </ion-row>
          }
          @if (averageData) {
            <ion-row style="background: var(--bg-secondary); font-weight: bold">
              <ion-col size="4">{{ averageData.name }}</ion-col>
              <ion-col size="4">{{ averageData.firstRead }}</ion-col>
              <ion-col size="4">{{ averageData.lastRead }}</ion-col>
            </ion-row>
          }
        </ion-grid>
      </ion-card-content>
    </ion-card>
  }

  <!-- Add New Measurement Form -->
  <ion-card class="glass-card">
    <ion-card-header>
      <ion-card-title>{{ 'resistance.form.title' | transloco }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <form (ngSubmit)="saveMeasurement()">
        <!-- Date Input -->
        <ion-item>
          <ion-label position="stacked">{{ 'resistance.form.date' | transloco }}</ion-label>
          <ion-input type="date" [(ngModel)]="newMeasurementDate" name="measurementDate" required>
          </ion-input>
        </ion-item>

        <!-- Resistance Values -->
        <div style="margin-top: 16px">
          <div style="margin-bottom: 8px">
            <strong>{{ 'resistance.form.cellValues' | transloco }}</strong>
          </div>

          @for (value of newResistanceValues; track $index; let i = $index) {
            <div style="margin-bottom: 8px">
              <ion-item>
                <ion-label position="stacked"
                  >{{ 'resistance.form.cellLabel' | transloco }} {{ i + 1 }} (mÎ©)</ion-label
                >
                <ion-input
                  type="number"
                  step="0.01"
                  min="0"
                  [(ngModel)]="newResistanceValues[i]"
                  [name]="'cell' + i"
                  placeholder="0.00"
                  required
                >
                </ion-input>
              </ion-item>
            </div>
          }
        </div>

        <!-- Submit Button -->
        <div style="margin-top: 16px">
          <ion-button type="submit" expand="block" [disabled]="isSaving || hasInvalidValues()">
            @if (isSaving) {
              <ion-icon name="hourglass" slot="start"></ion-icon>
            }
            {{
              isSaving
                ? ('resistance.form.saving' | transloco)
                : ('resistance.form.save' | transloco)
            }}
          </ion-button>
        </div>
      </form>
    </ion-card-content>
  </ion-card>
</ion-content>
<ion-footer>
  <ion-toolbar>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">{{ 'common.cancel' | transloco }}</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-footer>
